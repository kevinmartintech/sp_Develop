{
  "id": "14a67742-04d1-42a6-ba94-5b6d412c1a63",
  "prefix": "FindFileLevelLatency",
  "description": "KM: Use the Microsoft Troubleshoot SQL Server slow performance caused by IO query.",
  "body": "/* https://learn.microsoft.com/en-us/troubleshoot/sql/database-engine/performance/troubleshoot-sql-io-performance#file-stats-in-sysdm_io_virtual_file_stats */\r\n\r\nSELECT\r\n    Volume             = LEFT(mf.physical_name, 100)\r\n   ,ReadLatency        = CASE WHEN vfs.num_of_reads = 0 THEN 0 ELSE (vfs.io_stall_read_ms / vfs.num_of_reads) END\r\n   ,WriteLatency       = CASE WHEN vfs.num_of_writes = 0 THEN 0 ELSE (vfs.io_stall_write_ms / vfs.num_of_writes) END\r\n   ,AvgLatency         = CASE WHEN (vfs.num_of_reads = 0 AND vfs.num_of_writes = 0)\r\n                                  THEN 0\r\n                             ELSE (vfs.io_stall / (vfs.num_of_reads + vfs.num_of_writes))\r\n                         END\r\n   ,LatencyAssessment  = CASE WHEN (vfs.num_of_reads = 0 AND vfs.num_of_writes = 0)\r\n                                  THEN 'No data'\r\n                             ELSE CASE WHEN (vfs.io_stall / (vfs.num_of_reads + vfs.num_of_writes)) < 2\r\n                                           THEN 'Excellent'\r\n                                      WHEN (vfs.io_stall / (vfs.num_of_reads + vfs.num_of_writes)) BETWEEN 2 AND 5\r\n                                          THEN 'Very good'\r\n                                      WHEN (vfs.io_stall / (vfs.num_of_reads + vfs.num_of_writes)) BETWEEN 6 AND 15\r\n                                          THEN 'Good'\r\n                                      WHEN (vfs.io_stall / (vfs.num_of_reads + vfs.num_of_writes)) BETWEEN 16 AND 100\r\n                                          THEN 'Poor'\r\n                                      WHEN (vfs.io_stall / (vfs.num_of_reads + vfs.num_of_writes)) BETWEEN 100 AND 500\r\n                                          THEN 'Bad'\r\n                                      ELSE 'Deplorable'\r\n                                  END\r\n                         END\r\n   ,[Avg KBs/Transfer] = CASE WHEN (vfs.num_of_reads = 0 AND vfs.num_of_writes = 0)\r\n                                  THEN 0\r\n                             ELSE (((vfs.num_of_bytes_read + vfs.num_of_bytes_written) / (vfs.num_of_reads + vfs.num_of_writes)) / 1024)\r\n                         END\r\n   ,Volume             = LEFT(mf.physical_name, 2)\r\n   ,[Database Name]    = LEFT(DB_NAME(vfs.database_id), 32)\r\nFROM\r\n    sys.dm_io_virtual_file_stats(NULL, NULL) AS vfs\r\nINNER JOIN sys.master_files                  AS mf ON vfs.database_id = mf.database_id\r\n                                                   AND vfs.file_id    = mf.file_id\r\nORDER BY\r\n    AvgLatency DESC;"
}