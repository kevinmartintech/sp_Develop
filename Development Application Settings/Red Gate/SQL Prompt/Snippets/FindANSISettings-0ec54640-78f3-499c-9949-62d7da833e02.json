{
  "id": "0ec54640-78f3-499c-9949-62d7da833e02",
  "prefix": "FindANSISettings",
  "description": "KM: SQL Server Database and Object ANSI Settings Check",
  "body": "/**********************************************************************************************************************\r\n** Name:        SQL Server Database and Object ANSI Settings Check\r\n** Description: Validates that database-level ANSI settings, object-level metadata (ANSI_NULLS, QUOTED_IDENTIFIER), \r\n**               DDL SET options, and column-level ANSI_PADDING are correctly configured to ensure compatibility with \r\n**               indexed views, filtered indexes, persisted computed columns, and standards-based T-SQL behavior.\r\n**\r\n** NOTE:        MANUAL CHECK REQUIRED FOR TABLES\r\n**               Tables do not store ANSI_NULLS or QUOTED_IDENTIFIER settings in metadata. These settings are \r\n**               session-level at creation and cannot be altered later.\r\n**               To check:\r\n**                 1) Use SSMS Generate Scripts task to script out all tables.\r\n**                 2) Search the script for SET ANSI_NULLS OFF and SET QUOTED_IDENTIFIER OFF.\r\n**                 3) If found, recreate those tables with both options set to ON to ensure compliance for indexed \r\n**                    views, computed columns, and standards-based behavior.\r\n**********************************************************************************************************************/\r\nSET NOCOUNT ON;\r\n\r\n/**********************************************************************************************************************\r\n** Database Default Settigns Issues\r\n**********************************************************************************************************************/\r\nSELECT\r\n    ObjectType  = 'DATABASE'\r\n   ,SchemaName  = NULL\r\n   ,ObjectName  = D.name\r\n   ,IssueType   = 'Database Default'\r\n   ,IssueDetail = I.IssueDetail\r\nFROM\r\n    sys.databases AS D\r\nCROSS APPLY (\r\n    SELECT\r\n        'ANSI_NULLS must be ON'\r\n    WHERE\r\n        D.is_ansi_nulls_on <> 1\r\n    UNION ALL\r\n    SELECT\r\n        'ANSI_PADDING must be ON'\r\n    WHERE\r\n        D.is_ansi_padding_on <> 1\r\n    UNION ALL\r\n    SELECT\r\n        'ANSI_WARNINGS must be ON'\r\n    WHERE\r\n        D.is_ansi_warnings_on <> 1\r\n    UNION ALL\r\n    SELECT\r\n        'ARITHABORT must be ON'\r\n    WHERE\r\n        D.is_arithabort_on <> 1\r\n    UNION ALL\r\n    SELECT\r\n        'CONCAT_NULL_YIELDS_NULL must be ON'\r\n    WHERE\r\n        D.is_concat_null_yields_null_on <> 1\r\n    UNION ALL\r\n    SELECT\r\n        'NUMERIC_ROUNDABORT must be OFF'\r\n    WHERE\r\n        D.is_numeric_roundabort_on <> 0\r\n    UNION ALL\r\n    SELECT\r\n        'QUOTED_IDENTIFIER must be ON'\r\n    WHERE\r\n        D.is_quoted_identifier_on <> 1\r\n)                 AS I(IssueDetail)\r\nWHERE\r\n    D.name = DB_NAME()\r\n\r\nUNION ALL\r\n\r\n/**********************************************************************************************************************\r\n** Object-Level Metadata AND DDL Issues\r\n**********************************************************************************************************************/\r\nSELECT\r\n    ObjectType  = O.type_desc\r\n   ,SchemaName  = S.name\r\n   ,ObjectName  = O.name\r\n   ,IssueType   = I.IssueType\r\n   ,IssueDetail = I.IssueDetail\r\nFROM\r\n    sys.sql_modules    AS SM\r\nINNER JOIN sys.objects AS O ON SM.object_id = O.object_id\r\nINNER JOIN sys.schemas AS S ON O.schema_id = S.schema_id\r\nCROSS APPLY (\r\n    SELECT\r\n        IssueType   = 'Metadata'\r\n       ,IssueDetail = 'ANSI_NULLS is OFF'\r\n    WHERE\r\n        SM.uses_ansi_nulls = 0\r\n    UNION ALL\r\n    SELECT\r\n        'Metadata'\r\n       ,'QUOTED_IDENTIFIER is OFF'\r\n    WHERE\r\n        SM.uses_quoted_identifier = 0\r\n    UNION ALL\r\n    SELECT\r\n        'DDL'\r\n       ,'SET ANSI_PADDING OFF found in definition'\r\n    WHERE\r\n        SM.definition LIKE '%SET ANSI_PADDING OFF%'\r\n    UNION ALL\r\n    SELECT\r\n        'DDL'\r\n       ,'SET ANSI_WARNINGS OFF found in definition'\r\n    WHERE\r\n        SM.definition LIKE '%SET ANSI_WARNINGS OFF%'\r\n    UNION ALL\r\n    SELECT\r\n        'DDL'\r\n       ,'SET ARITHABORT OFF found in definition'\r\n    WHERE\r\n        SM.definition LIKE '%SET ARITHABORT OFF%'\r\n    UNION ALL\r\n    SELECT\r\n        'DDL'\r\n       ,'SET CONCAT_NULL_YIELDS_NULL OFF found in definition'\r\n    WHERE\r\n        SM.definition LIKE '%SET CONCAT_NULL_YIELDS_NULL OFF%'\r\n    UNION ALL\r\n    SELECT\r\n        'DDL'\r\n       ,'SET NUMERIC_ROUNDABORT ON found in definition'\r\n    WHERE\r\n        SM.definition LIKE '%SET NUMERIC_ROUNDABORT ON%'\r\n)                      AS I\r\n\r\nUNION ALL\r\n\r\n/**********************************************************************************************************************\r\n** Column-Level ANSI_PADDING Issues (Only char, varchar, binary, varbinary)\r\n**********************************************************************************************************************/\r\nSELECT\r\n    ObjectType  = 'COLUMN'\r\n   ,SchemaName  = S.name\r\n   ,ObjectName  = T.name + '.' + C.name\r\n   ,IssueType   = 'Metadata'\r\n   ,IssueDetail = 'ANSI_PADDING is OFF'\r\nFROM\r\n    sys.columns        AS C\r\nINNER JOIN sys.tables  AS T ON C.object_id       = T.object_id\r\nINNER JOIN sys.schemas AS S ON T.schema_id       = S.schema_id\r\nINNER JOIN sys.types   AS TP ON C.system_type_id = TP.system_type_id\r\nWHERE\r\n    C.is_ansi_padded = 0\r\nAND TP.name IN ('char', 'varchar', 'binary', 'varbinary')\r\n\r\nUNION ALL\r\n\r\n/**********************************************************************************************************************\r\n** Table ANSI_NULLS and QUOTED_IDENTIFIER Manual Check Instructions\r\n**********************************************************************************************************************/\r\nSELECT\r\n    ObjectType  = 'TABLE'\r\n   ,SchemaName  = NULL\r\n   ,ObjectName  = NULL\r\n   ,IssueType   = 'Manual Check Required'\r\n   ,IssueDetail = 'Tables do not store ANSI_NULLS or QUOTED_IDENTIFIER settings in metadata. These settings are session-level at creation and cannot be altered later. To check: 1) Use SSMS Generate Scripts task to script out all tables. 2) Search the script for SET ANSI_NULLS OFF and SET QUOTED_IDENTIFIER OFF. 3) If found, recreate those tables with both options set to ON to ensure compliance for indexed views, computed columns, and standards-based behavior.'\r\nORDER BY\r\n    ObjectType\r\n   ,SchemaName\r\n   ,ObjectName\r\n   ,IssueType;\r\nGO"
}