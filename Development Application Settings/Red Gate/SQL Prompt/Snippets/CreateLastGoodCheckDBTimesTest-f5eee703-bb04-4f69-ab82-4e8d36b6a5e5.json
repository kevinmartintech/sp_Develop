{
  "id": "f5eee703-bb04-4f69-ab82-4e8d36b6a5e5",
  "prefix": "CreateLastGoodCheckDBTimesTest",
  "description": "Use this against multiple SQL Servers through SSMS Registered Servers to check the last good check DBCC CHECKDB.",
  "body": "/* https://www.brentozar.com/archive/2014/05/dbcc-checkdb-faq/ */\r\n\r\nDROP TABLE IF EXISTS #LastGoodCheckDBTimes;\r\nCREATE TABLE #LastGoodCheckDBTimes (\r\n    ServerName          sysname  NULL\r\n   ,DatabaseName        sysname  NULL\r\n   ,LastGoodCheckDbTime datetime NULL\r\n);\r\n\r\nDECLARE @NewLineString nvarchar(MAX) = CAST(CHAR(13) + CHAR(10) AS nvarchar(MAX));\r\nDECLARE @StringToExecute nvarchar(MAX) = N'';\r\n\r\nSELECT\r\n    @StringToExecute = @StringToExecute + @NewLineString + N'\r\nINSERT INTO #LastGoodCheckDBTimes (ServerName, DatabaseName, LastGoodCheckDbTime)\r\nSELECT \r\n     ServerName = '''  + @@SERVERNAME + N'''\r\n    ,DatabaseName = ''' + name + N'''\r\n    ,LastGoodCheckDbTime = CAST(DATABASEPROPERTYEX(''' + name + N''', ''LastGoodCheckDbTime'') AS DATETIME2(7));'\r\nFROM\r\n    sys.databases\r\nWHERE\r\n    state_desc = N'ONLINE'\r\nAND (\r\n    name LIKE 'CGPdfSearch%'\r\n    OR name LIKE 'CGWebApps%'\r\n    OR name LIKE 'PLS%'\r\n    OR name LIKE 'OperationalDataStore%'\r\n    OR name LIKE 'VentureAccess%'\r\n    OR name LIKE 'CentraAccessDirectMessageTracking%'\r\n    OR name LIKE 'SSISDB'\r\n    OR name LIKE 'RedGate%'\r\n    OR name LIKE 'master'\r\n    OR name LIKE 'model'\r\n    OR name LIKE 'msdb'\r\n    /* OR name LIKE 'tempdb' */ /* Sunitha Sajja said they were not going to perform this on prduction and will setup aone-off jobs on VENFW3SQLS2 and VENNM3SQLD2 to evaluate. */\r\n);\r\n\r\n/* PRINT @StringToExecute; */\r\nEXEC sys.sp_executesql @stmt = @StringToExecute;\r\n\r\nSELECT\r\n    ServerName\r\n   ,DatabaseName\r\n   ,LastGoodCheckDbTime\r\nFROM\r\n    #LastGoodCheckDBTimes\r\nWHERE\r\n  LastGoodCheckDbTime < DATEADD(DAY, -7, GETDATE())\r\nAND ServerName NOT IN ('VENSSQL02-OLD', 'VENNM3SQLD8')\r\nORDER BY\r\n    ServerName\r\n   ,DatabaseName;"
}