{
  "id": "370c8c0a-5551-4dab-9699-70e1a2e73663",
  "prefix": "FindUntrustedForeignKeysAndCheckConstraints",
  "description": "KM: To find untrusted foreign keys and check constraints in your database run the script below to identify and create an ALTER statement to correct the issue.",
  "body": "SELECT\r\n    SchemaName = S.name\r\n   ,TableName  = T.name\r\n   ,ObjectName = FK.name\r\n   ,ObjectType = 'FOREIGN KEY'\r\n   ,FixSQL     = 'ALTER TABLE ' + QUOTENAME(S.name) + '.' + QUOTENAME(T.name) + ' WITH CHECK CHECK CONSTRAINT ' + FK.name + ';'\r\nFROM\r\n    sys.foreign_keys       AS FK\r\n    INNER JOIN sys.tables  AS T\r\n        ON FK.parent_object_id = T.object_id\r\n    INNER JOIN sys.schemas AS S\r\n        ON T.schema_id         = S.schema_id\r\nWHERE\r\n    FK.is_not_trusted         = 1\r\nAND FK.is_not_for_replication = 0\r\n\r\nUNION ALL\r\n\r\nSELECT\r\n    SchemaName = S.name\r\n   ,TableName  = T.name\r\n   ,ObjectName = CC.name\r\n   ,ObjectType = 'CHECK CONSTRAINT'\r\n   ,FixSQL     = 'ALTER TABLE ' + QUOTENAME(S.name) + '.' + QUOTENAME(T.name) + ' WITH CHECK CHECK CONSTRAINT ' + CC.name + ';'\r\nFROM\r\n    sys.check_constraints  AS CC\r\n    INNER JOIN sys.tables  AS T\r\n        ON CC.parent_object_id = T.object_id\r\n    INNER JOIN sys.schemas AS S\r\n        ON T.schema_id         = S.schema_id\r\nWHERE\r\n    CC.is_not_trusted         = 1\r\nAND CC.is_not_for_replication = 0\r\nAND CC.is_disabled            = 0\r\nORDER BY\r\n    SchemaName ASC\r\n   ,TableName ASC\r\n   ,ObjectName ASC;\r\n"
}