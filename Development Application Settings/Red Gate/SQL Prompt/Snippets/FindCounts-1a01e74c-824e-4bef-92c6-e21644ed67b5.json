{
  "id": "1a01e74c-824e-4bef-92c6-e21644ed67b5",
  "prefix": "FindCounts",
  "description": "KM: Safe count all rows in all tables (does not lock tables)",
  "body": "SET NOCOUNT ON;\r\nSET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\nSET LOCK_TIMEOUT 1000;\r\n\r\nWITH PerTableNumbers\r\n  AS (\r\n      SELECT\r\n          SchemaName  = S.name\r\n         ,TableName   = T.name\r\n         ,RowsN       = SUM(CASE WHEN D.index_id IN (0, 1) THEN D.row_count ELSE 0 END)\r\n         ,TotalPages  = SUM(D.reserved_page_count)\r\n         ,UsedPages   = SUM(D.used_page_count)\r\n      FROM\r\n          sys.tables                  AS T\r\n          INNER JOIN sys.schemas      AS S ON S.schema_id = T.schema_id\r\n          INNER JOIN sys.dm_db_partition_stats AS D ON D.object_id = T.object_id\r\n      WHERE\r\n          T.name NOT LIKE 'dt%'\r\n      AND T.is_ms_shipped = 0\r\n      AND T.object_id     > 255\r\n      GROUP BY\r\n          S.name\r\n         ,T.name\r\n     )\r\n    ,AllNumbers\r\n  AS (\r\n      SELECT\r\n          SchemaName  = N'.All'\r\n         ,TableName   = N'.All'\r\n         ,RowsN       = SUM(N.RowsN)\r\n         ,TotalPages  = SUM(N.TotalPages)\r\n         ,UsedPages   = SUM(N.UsedPages)\r\n      FROM\r\n          PerTableNumbers AS N\r\n     )\r\n    ,PerTableFormatted\r\n  AS (\r\n      SELECT\r\n          SchemaName = N.SchemaName\r\n         ,TableName  = N.TableName\r\n         ,Rows       = FORMAT(N.RowsN, '#,##0')\r\n         ,TotalTB    = FORMAT(CAST((N.TotalPages * 8) / 1024.000 / 1024.000 / 1024.000 AS numeric(18, 4)), '#,##0.#000')\r\n         ,TotalGB    = FORMAT(CAST((N.TotalPages * 8) / 1024.000 / 1024.000 AS numeric(18, 3)), '#,##0.#0')\r\n         ,TotalMB    = FORMAT(CAST(((N.TotalPages * 8) / 1024.00) AS numeric(36, 2)), '#,##0.#0')\r\n         ,TotalKB    = FORMAT(N.TotalPages * 8, '#,##0')\r\n         ,UsedGB     = FORMAT(CAST((N.UsedPages * 8) / 1024.000 / 1024.000 AS numeric(18, 3)), '#,##0.#0')\r\n         ,UsedMB     = FORMAT(CAST(((N.UsedPages * 8) / 1024.00) AS numeric(36, 2)), '#,##0.#0')\r\n         ,UsedKB     = FORMAT(N.UsedPages * 8, '#,##0')\r\n         ,UnusedGB   = FORMAT(CAST(((N.TotalPages - N.UsedPages) * 8) / 1024.000 / 1024.000 AS numeric(18, 3)), '#,##0.#0')\r\n         ,UnusedMB   = FORMAT(CAST((((N.TotalPages - N.UsedPages) * 8) / 1024.00) AS numeric(36, 2)), '#,##0.#0')\r\n         ,UnusedKB   = FORMAT((N.TotalPages - N.UsedPages) * 8, '#,##0')\r\n      FROM\r\n          PerTableNumbers AS N\r\n     )\r\n    ,AllFormatted\r\n  AS (\r\n      SELECT\r\n          SchemaName = A.SchemaName\r\n         ,TableName  = A.TableName\r\n         ,Rows       = FORMAT(A.RowsN, '#,##0')\r\n         ,TotalTB    = FORMAT(CAST((A.TotalPages * 8) / 1024.000 / 1024.000 / 1024.000 AS numeric(18, 4)), '#,##0.#000')\r\n         ,TotalGB    = FORMAT(CAST((A.TotalPages * 8) / 1024.000 / 1024.000 AS numeric(18, 3)), '#,##0.#0')\r\n         ,TotalMB    = FORMAT(CAST(((A.TotalPages * 8) / 1024.00) AS numeric(36, 2)), '#,##0.#0')\r\n         ,TotalKB    = FORMAT(A.TotalPages * 8, '#,##0')\r\n         ,UsedGB     = FORMAT(CAST((A.UsedPages * 8) / 1024.000 / 1024.000 AS numeric(18, 3)), '#,##0.#0')\r\n         ,UsedMB     = FORMAT(CAST(((A.UsedPages * 8) / 1024.00) AS numeric(36, 2)), '#,##0.#0')\r\n         ,UsedKB     = FORMAT(A.UsedPages * 8, '#,##0')\r\n         ,UnusedGB   = FORMAT(CAST(((A.TotalPages - A.UsedPages) * 8) / 1024.000 / 1024.000 AS numeric(18, 3)), '#,##0.#0')\r\n         ,UnusedMB   = FORMAT(CAST((((A.TotalPages - A.UsedPages) * 8) / 1024.00) AS numeric(36, 2)), '#,##0.#0')\r\n         ,UnusedKB   = FORMAT((A.TotalPages - A.UsedPages) * 8, '#,##0')\r\n      FROM\r\n          AllNumbers AS A\r\n     )\r\nSELECT\r\n    *\r\nFROM\r\n    AllFormatted\r\nUNION ALL\r\nSELECT\r\n    *\r\nFROM\r\n    PerTableFormatted\r\n--WHERE SchemaName IN (N'.All', N'SomeSchemaName')\r\n--AND   TableName  IN (N'.All', N'SomeTableName')\r\nORDER BY\r\n    SchemaName\r\n   ,TableName\r\nOPTION (RECOMPILE);"
}