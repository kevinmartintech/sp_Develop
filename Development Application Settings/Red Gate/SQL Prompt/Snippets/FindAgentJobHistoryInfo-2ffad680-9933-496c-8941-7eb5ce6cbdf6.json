{
  "id": "2ffad680-9933-496c-8941-7eb5ce6cbdf6",
  "prefix": "FindAgentJobHistoryInfo",
  "description": "KM: This script finds agent job history and agent job info. Use it instead of the Job History / Log File Viewer",
  "body": "DECLARE @JobName sysname = N'[SQL-SERVER-AGENT-JOB-NAME]'; /* Enter the job name you want to view the job history for */\r\nDECLARE @DaysBack int = 5; /* Change this value as needed */\r\nDECLARE @ShowOnlyJobSummary bit = 1; /* Set to 1 for just the summary, or 0 for all job steps */\r\nDECLARE @ShowJobInformation bit = 0; /* Set to 1 to view the job information. You can also view this in SSMS under SQL Server Agent -> Jobs */\r\n\r\n/**********************************************************************************************************************\r\n** Job History\r\n**********************************************************************************************************************/\r\nSET NOCOUNT ON;\r\n\r\nSELECT\r\n    Date                = FORMAT(CONVERT(datetime, CONVERT(char(8), SJH.run_date, 112) + ' ' + STUFF(STUFF(RIGHT('000000' + CAST(SJH.run_time AS varchar(6)), 6), 3, 0, ':'), 6, 0, ':')), 'MM/dd/yyyy hh:mm:ss tt')\r\n   ,[Step ID]           = SJH.step_id\r\n   ,[Step Name]         = ISNULL(SJS.step_name, 'Job Status')\r\n   ,Status              = CASE SJH.run_status\r\n                              WHEN 0\r\n                                  THEN 'Failed'\r\n                              WHEN 1\r\n                                  THEN 'Succeeded'\r\n                              WHEN 2\r\n                                  THEN 'Retry'\r\n                              WHEN 3\r\n                                  THEN 'Canceled'\r\n                              WHEN 4\r\n                                  THEN 'In Progress'\r\n                              ELSE 'Unknown'\r\n                          END\r\n   ,[Job Name]          = SJ.name\r\n   ,Message             = SJH.message\r\n   ,Duration            = STUFF(STUFF(RIGHT('00000' + CAST(SJH.run_duration AS varchar(6)), 6), 3, 0, ':'), 6, 0, ':')\r\n   ,[Retries Attempted] = SJH.retries_attempted\r\nFROM\r\n    msdb.dbo.sysjobs                     AS SJ\r\nINNER JOIN msdb.dbo.sysjobhistory        AS SJH ON SJ.job_id     = SJH.job_id\r\nLEFT OUTER JOIN msdb.dbo.sysjobsteps     AS SJS ON SJH.job_id    = SJS.job_id\r\n                                                AND SJH.step_id  = SJS.step_id\r\nLEFT OUTER JOIN msdb.dbo.sysjobstepslogs AS SJSL ON SJS.step_uid = SJSL.step_uid\r\nWHERE\r\n    SJ.name              = @JobName\r\nAND SJH.run_date         > CONVERT(int, CONVERT(char(8), DATEADD(DAY, -@DaysBack, GETDATE()), 112))\r\nAND (@ShowOnlyJobSummary = 0 OR SJH.step_id = 0)\r\nORDER BY\r\n    SJH.run_date DESC\r\n   ,SJH.run_time DESC\r\n   ,SJH.step_id DESC;\r\n\r\n\r\n/**********************************************************************************************************************\r\n** View Job Information\r\n**********************************************************************************************************************/\r\nIF @ShowJobInformation = 1\r\n    BEGIN\r\n\r\n        SELECT\r\n            JobName     = SJ.name\r\n           ,Enabled     = SJ.enabled\r\n           ,StartStepId = SJ.start_step_id\r\n           ,StepId      = SJS.step_id\r\n           ,StepName    = SJS.step_name\r\n           ,Subsystem   = SJS.subsystem\r\n           ,Command     = SJS.command\r\n           ,OnSuccess   = CASE SJS.on_success_action\r\n                              WHEN 1\r\n                                  THEN 'Quit with success'\r\n                              WHEN 2\r\n                                  THEN 'Quit with failure'\r\n                              WHEN 3\r\n                                  THEN 'Go to next step'\r\n                              WHEN 4\r\n                                  THEN 'Go to step ' + CAST(SJS.on_success_step_id AS varchar(3))\r\n                              ELSE 'Unknown'\r\n                          END\r\n           ,OnFailure   = CASE SJS.on_fail_action\r\n                              WHEN 1\r\n                                  THEN 'Quit with success'\r\n                              WHEN 2\r\n                                  THEN 'Quit with failure'\r\n                              WHEN 3\r\n                                  THEN 'Go to next step'\r\n                              WHEN 4\r\n                                  THEN 'Go to step ' + CAST(SJS.on_fail_step_id AS varchar(3))\r\n                              ELSE 'Unknown'\r\n                          END\r\n        FROM\r\n            msdb.dbo.sysjobs            AS SJ\r\n        INNER JOIN msdb.dbo.sysjobsteps AS SJS ON SJ.job_id = SJS.job_id\r\n        WHERE\r\n            SJ.name = @JobName;\r\n\r\n    END;"
}