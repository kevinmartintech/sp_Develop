{
  "id": "2ffad680-9933-496c-8941-7eb5ce6cbdf6",
  "prefix": "FindAgentJobHistoryInfo",
  "description": "KM: This script finds agent job history and agent job info. Use it instead of the Job History / Log File Viewer",
  "body": "DECLARE @JobName sysname = N'[SQL-SERVER-AGENT-JOB-NAME]'; /* Enter the job name you want to view the job history for */\r\nDECLARE @DaysBack int = 30; /* Change this value as needed */\r\nDECLARE @ShowOnlyJobSummary bit = 1; /* Set to 1 for just the summary, or 0 for all job steps */\r\nDECLARE @ShowJobInformation bit = 0; /* Set to 1 to view the job information. You can also view this in SSMS under SQL Server Agent -> Jobs */\r\nDECLARE @ShowAllJobSummary bit = 0; /* Set to 1 to view the All Job Summary - Slowest and Fastest Durations results */\r\n\r\n/**********************************************************************************************************************\r\n** Specific Job History\r\n**********************************************************************************************************************/\r\nSET NOCOUNT ON;\r\n\r\nSELECT\r\n    Date                = FORMAT(CONVERT(datetime, CONVERT(char(8), SJH.run_date, 112) + ' ' + STUFF(STUFF(RIGHT('000000' + CAST(SJH.run_time AS varchar(6)), 6), 3, 0, ':'), 6, 0, ':')), 'MM/dd/yyyy hh:mm:ss tt')\r\n   ,[Step ID]           = SJH.step_id\r\n   ,[Step Name]         = ISNULL(SJS.step_name, 'Job Status')\r\n   ,Status              = CASE SJH.run_status\r\n                              WHEN 0\r\n                                  THEN 'Failed'\r\n                              WHEN 1\r\n                                  THEN 'Succeeded'\r\n                              WHEN 2\r\n                                  THEN 'Retry'\r\n                              WHEN 3\r\n                                  THEN 'Canceled'\r\n                              WHEN 4\r\n                                  THEN 'In Progress'\r\n                              ELSE 'Unknown'\r\n                          END\r\n   ,[Job Name]          = SJ.name\r\n   ,Message             = SJH.message\r\n   ,Duration            = STUFF(STUFF(RIGHT('00000' + CAST(SJH.run_duration AS varchar(6)), 6), 3, 0, ':'), 6, 0, ':')\r\n   ,[Retries Attempted] = SJH.retries_attempted\r\nFROM\r\n    msdb.dbo.sysjobs                     AS SJ\r\nINNER JOIN msdb.dbo.sysjobhistory        AS SJH ON SJ.job_id     = SJH.job_id\r\nLEFT OUTER JOIN msdb.dbo.sysjobsteps     AS SJS ON SJH.job_id    = SJS.job_id\r\n                                                AND SJH.step_id  = SJS.step_id\r\nLEFT OUTER JOIN msdb.dbo.sysjobstepslogs AS SJSL ON SJS.step_uid = SJSL.step_uid\r\nWHERE\r\n    SJ.name              = @JobName\r\nAND SJH.run_date         > CONVERT(int, CONVERT(char(8), DATEADD(DAY, -@DaysBack, GETDATE()), 112))\r\nAND (@ShowOnlyJobSummary = 0 OR SJH.step_id = 0)\r\nORDER BY\r\n    SJH.run_date DESC\r\n   ,SJH.run_time DESC\r\n   ,SJH.step_id DESC;\r\n\r\n/**********************************************************************************************************************\r\n** View Specific Job Information\r\n**********************************************************************************************************************/\r\nIF @ShowJobInformation = 1\r\n    BEGIN\r\n\r\n        SELECT\r\n            JobName     = SJ.name\r\n           ,Enabled     = SJ.enabled\r\n           ,StartStepId = SJ.start_step_id\r\n           ,StepId      = SJS.step_id\r\n           ,StepName    = SJS.step_name\r\n           ,Subsystem   = SJS.subsystem\r\n           ,Command     = SJS.command\r\n           ,OnSuccess   = CASE SJS.on_success_action\r\n                              WHEN 1\r\n                                  THEN 'Quit with success'\r\n                              WHEN 2\r\n                                  THEN 'Quit with failure'\r\n                              WHEN 3\r\n                                  THEN 'Go to next step'\r\n                              WHEN 4\r\n                                  THEN 'Go to step ' + CAST(SJS.on_success_step_id AS varchar(3))\r\n                              ELSE 'Unknown'\r\n                          END\r\n           ,OnFailure   = CASE SJS.on_fail_action\r\n                              WHEN 1\r\n                                  THEN 'Quit with success'\r\n                              WHEN 2\r\n                                  THEN 'Quit with failure'\r\n                              WHEN 3\r\n                                  THEN 'Go to next step'\r\n                              WHEN 4\r\n                                  THEN 'Go to step ' + CAST(SJS.on_fail_step_id AS varchar(3))\r\n                              ELSE 'Unknown'\r\n                          END\r\n        FROM\r\n            msdb.dbo.sysjobs            AS SJ\r\n        INNER JOIN msdb.dbo.sysjobsteps AS SJS ON SJ.job_id = SJS.job_id\r\n        WHERE\r\n            SJ.name = @JobName;\r\n\r\n    END;\r\n\r\n/**********************************************************************************************************************\r\n** All Job Summary - Slowest and Fastest Durations\r\n**********************************************************************************************************************/\r\n\r\nIF @ShowAllJobSummary = 1\r\n    BEGIN\r\n        ;WITH JobHistory\r\n           AS (\r\n               SELECT\r\n                   JobId           = SJ.job_id\r\n                  ,JobName         = SJ.name\r\n                  ,RunDateTime     = CONVERT(datetime2(0), CONVERT(char(8), SJH.run_date, 112) + ' ' + STUFF(STUFF(RIGHT('000000' + CONVERT(varchar(6), SJH.run_time), 6), 3, 0, ':'), 6, 0, ':'))\r\n                  ,RunStatus       = SJH.run_status\r\n                  ,DurationSeconds = (SJH.run_duration / 10000) * 3600 + ((SJH.run_duration % 10000) / 100) * 60 + (SJH.run_duration % 100)\r\n               FROM\r\n                   msdb.dbo.sysjobs              AS SJ\r\n               INNER JOIN msdb.dbo.sysjobhistory AS SJH ON SJ.job_id = SJH.job_id\r\n               WHERE\r\n                   SJH.step_id  = 0\r\n               AND SJH.run_date > CONVERT(int, CONVERT(char(8), DATEADD(DAY, -@DaysBack, GETDATE()), 112))\r\n               AND SJH.run_status IN (0, 1, 2, 3)/* Excludes \"In Progress\" (4) */\r\n           )\r\n        ,Ranked\r\n           AS (\r\n               SELECT\r\n                   JobId\r\n                  ,JobName\r\n                  ,RunDateTime\r\n                  ,RunStatus\r\n                  ,DurationSeconds\r\n                  ,RowNumFastest = ROW_NUMBER() OVER (PARTITION BY JobId ORDER BY DurationSeconds ASC, RunDateTime ASC)\r\n                  ,RowNumSlowest = ROW_NUMBER() OVER (PARTITION BY JobId ORDER BY DurationSeconds DESC, RunDateTime DESC)\r\n               FROM\r\n                   JobHistory\r\n           )\r\n        ,Agg\r\n           AS (\r\n               SELECT\r\n                   JobId\r\n                  ,Runs               = COUNT_BIG(1)\r\n                  ,AvgDurationSeconds = AVG(CONVERT(decimal(19, 4), DurationSeconds))\r\n               FROM\r\n                   JobHistory\r\n               GROUP BY\r\n                   JobId\r\n           )\r\n        SELECT\r\n            JobName                = RFast.JobName\r\n           ,Runs                   = A.Runs\r\n           ,AvgDurationSeconds     = A.AvgDurationSeconds\r\n           ,AvgDurationHHMMSS      = CONVERT(varchar(12), CONVERT(bigint, A.AvgDurationSeconds) / 3600) + ':' + RIGHT('00' + CONVERT(varchar(2), (CONVERT(bigint, A.AvgDurationSeconds) % 3600) / 60), 2)\r\n                                     + ':' + RIGHT('00' + CONVERT(varchar(2), CONVERT(bigint, A.AvgDurationSeconds) % 60), 2)\r\n\r\n           ,FastestRunDateTime     = RFast.RunDateTime\r\n           ,FastestDurationSeconds = RFast.DurationSeconds\r\n           ,FastestDurationHHMMSS  = CONVERT(varchar(12), RFast.DurationSeconds / 3600) + ':' + RIGHT('00' + CONVERT(varchar(2), (RFast.DurationSeconds % 3600) / 60), 2) + ':'\r\n                                     + RIGHT('00' + CONVERT(varchar(2), RFast.DurationSeconds % 60), 2)\r\n\r\n           ,SlowestRunDateTime     = RSlow.RunDateTime\r\n           ,SlowestDurationSeconds = RSlow.DurationSeconds\r\n           ,SlowestDurationHHMMSS  = CONVERT(varchar(12), RSlow.DurationSeconds / 3600) + ':' + RIGHT('00' + CONVERT(varchar(2), (RSlow.DurationSeconds % 3600) / 60), 2) + ':'\r\n                                     + RIGHT('00' + CONVERT(varchar(2), RSlow.DurationSeconds % 60), 2)\r\n        FROM\r\n            Agg           AS A\r\n        INNER JOIN Ranked AS RFast ON A.JobId              = RFast.JobId\r\n                                   AND RFast.RowNumFastest = 1\r\n        INNER JOIN Ranked AS RSlow ON A.JobId              = RSlow.JobId\r\n                                   AND RSlow.RowNumSlowest = 1\r\n        ORDER BY\r\n            RFast.JobName ASC;\r\n    END;\r\n"
}