{
  "id": "14a67742-04d1-42a6-ba94-5b6d412c1a63",
  "prefix": "FindFileLevelLatencySlowStorage",
  "description": "KM: Two queries to check for slow storage.",
  "body": "/* https://learn.microsoft.com/en-us/troubleshoot/sql/database-engine/performance/troubleshoot-sql-io-performance#file-stats-in-sysdm_io_virtual_file_stats */\r\n\r\nSELECT\r\n    VolumePath         = LEFT(mf.physical_name, 100)\r\n   ,ReadLatency        = CASE WHEN vfs.num_of_reads = 0 THEN 0 ELSE (vfs.io_stall_read_ms / vfs.num_of_reads) END\r\n   ,WriteLatency       = CASE WHEN vfs.num_of_writes = 0 THEN 0 ELSE (vfs.io_stall_write_ms / vfs.num_of_writes) END\r\n   ,AvgLatency         = CASE WHEN (vfs.num_of_reads = 0 AND vfs.num_of_writes = 0)\r\n                                  THEN 0\r\n                             ELSE (vfs.io_stall / (vfs.num_of_reads + vfs.num_of_writes))\r\n                         END\r\n   ,LatencyAssessment  = CASE WHEN (vfs.num_of_reads = 0 AND vfs.num_of_writes = 0)\r\n                                  THEN 'No data'\r\n                             ELSE CASE WHEN (vfs.io_stall / (vfs.num_of_reads + vfs.num_of_writes)) < 2\r\n                                           THEN 'Excellent'\r\n                                      WHEN (vfs.io_stall / (vfs.num_of_reads + vfs.num_of_writes)) BETWEEN 2 AND 5\r\n                                          THEN 'Very good'\r\n                                      WHEN (vfs.io_stall / (vfs.num_of_reads + vfs.num_of_writes)) BETWEEN 6 AND 15\r\n                                          THEN 'Good'\r\n                                      WHEN (vfs.io_stall / (vfs.num_of_reads + vfs.num_of_writes)) BETWEEN 16 AND 100\r\n                                          THEN 'Poor'\r\n                                      WHEN (vfs.io_stall / (vfs.num_of_reads + vfs.num_of_writes)) BETWEEN 100 AND 500\r\n                                          THEN 'Bad'\r\n                                      ELSE 'Deplorable'\r\n                                  END\r\n                         END\r\n   ,[Avg KBs/Transfer] = CASE WHEN (vfs.num_of_reads = 0 AND vfs.num_of_writes = 0)\r\n                                  THEN 0\r\n                             ELSE (((vfs.num_of_bytes_read + vfs.num_of_bytes_written) / (vfs.num_of_reads + vfs.num_of_writes)) / 1024)\r\n                         END\r\n   ,Drive              = LEFT(mf.physical_name, 2)\r\n   ,[Database Name]    = LEFT(DB_NAME(vfs.database_id), 32)\r\nFROM\r\n    sys.dm_io_virtual_file_stats(NULL, NULL) AS vfs\r\nINNER JOIN sys.master_files                  AS mf ON vfs.database_id = mf.database_id\r\n                                                   AND vfs.file_id    = mf.file_id\r\nORDER BY\r\n    AvgLatency DESC;\r\nGO\r\n\r\n/* https://www.brentozar.com/blitz/slow-storage-reads-writes/ */\r\n\r\nSELECT\r\n    [Database Name]           = DB_NAME(a.database_id)\r\n   ,[Logical File Name]       = b.name + N' [' + b.type_desc COLLATE SQL_Latin1_General_CP1_CI_AS + N']'\r\n   ,Drive                     = UPPER(SUBSTRING(b.physical_name, 1, 2))\r\n   ,[Size (GB)]               = CAST(((a.size_on_disk_bytes / 1024.0) / (1024.0 * 1024.0)) AS decimal(9, 2))\r\n   ,[Total IO Read Stall]     = a.io_stall_read_ms\r\n   ,[Total Reads]             = a.num_of_reads\r\n   ,[GB Read]                 = CASE WHEN a.num_of_bytes_read > 0\r\n                                         THEN CAST(a.num_of_bytes_read / 1024.0 / 1024.0 / 1024.0 AS numeric(23, 1))\r\n                                    ELSE 0\r\n                                END\r\n   ,[Avg Read Stall (ms)]     = CAST(a.io_stall_read_ms / (1.0 * a.num_of_reads) AS int)\r\n   ,[Max Rec Read Stall Avg]  = CASE WHEN b.type = 0 THEN 30 /* data files */\r\nWHEN b.type = 1 THEN 5                                       /* log files */\r\nELSE 0 END\r\n   ,[Total IO Write Stall]    = a.io_stall_write_ms\r\n   ,[Total Writes]            = a.num_of_writes\r\n   ,[GB Written]              = CASE WHEN a.num_of_bytes_written > 0\r\n                                         THEN CAST(a.num_of_bytes_written / 1024.0 / 1024.0 / 1024.0 AS numeric(23, 1))\r\n                                    ELSE 0\r\n                                END\r\n   ,[Avg Write Stall (ms)]    = CAST(a.io_stall_write_ms / (1.0 * a.num_of_writes) AS int)\r\n   ,[Max Rec Write Stall Avg] = CASE WHEN b.type = 0 THEN 30 /* data files */\r\nWHEN b.type = 1 THEN 2                                       /* log files */\r\nELSE 0 END\r\n   ,[Physical File Name]      = b.physical_name\r\n   ,[Read-Related Wait Stat]  = CASE WHEN b.name = 'tempdb'\r\n                                         THEN 'N/A'\r\n                                    WHEN b.type = 1\r\n                                        THEN 'N/A' /* log files */\r\n                                    ELSE 'PAGEIOLATCH*'\r\n                                END\r\n   ,[Write-Related Wait Stat] = CASE WHEN b.type = 1\r\n                                         THEN 'WRITELOG'           /* log files */\r\n                                    WHEN b.name = 'tempdb'\r\n                                        THEN 'xxx'                 /* tempdb data files */\r\n                                    WHEN b.type = 0\r\n                                        THEN 'ASYNC_IO_COMPLETION' /* data files */\r\n                                    ELSE 'xxx'\r\n                                END\r\n   ,[Sample Time]             = GETDATE()\r\n   ,b.type_desc\r\nFROM\r\n    sys.dm_io_virtual_file_stats(NULL, NULL) AS a\r\nINNER JOIN sys.master_files                  AS b ON a.file_id      = b.file_id\r\n                                                  AND a.database_id = b.database_id\r\nWHERE\r\n    a.num_of_reads  > 0\r\nAND a.num_of_writes > 0\r\nORDER BY\r\n    CAST(a.io_stall_read_ms / (1.0 * a.num_of_reads) AS int) DESC;\r\nGO"
}