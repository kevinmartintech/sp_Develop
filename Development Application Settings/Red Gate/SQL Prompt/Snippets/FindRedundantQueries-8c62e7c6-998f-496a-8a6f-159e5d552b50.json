{
  "id": "8c62e7c6-998f-496a-8a6f-159e5d552b50",
  "prefix": "FindRedundantQueries",
  "description": "KM: Find Redundant Queries. Used to export for devs to parameterize.",
  "body": "/*  Source: 82_plans_duplicated.sql \r\n    Used to export for devs to parameterize\r\n*/\r\n\r\nWITH RedundantQueries\r\n  AS (\r\n      SELECT TOP (20000)\r\n          s.query_hash\r\n         ,s.statement_start_offset\r\n         ,s.statement_end_offset\r\n         ,sort_order            = COUNT(s.query_hash)\r\n         ,PlansCached           = COUNT(s.query_hash)\r\n         ,DistinctPlansCached   = COUNT(DISTINCT (s.query_hash))\r\n         ,FirstPlanCreationTime = MIN(s.creation_time)\r\n         ,LastPlanCreationTime  = MAX(s.creation_time)\r\n         ,LastExecutionTime     = MAX(s.last_execution_time)\r\n         ,Total_CPU_ms          = SUM(s.total_worker_time)\r\n         ,Total_Duration_ms     = SUM(s.total_elapsed_time)\r\n         ,Total_Reads           = SUM(s.total_logical_reads)\r\n         ,Total_Writes          = SUM(s.total_logical_writes)\r\n         ,Total_Executions      = SUM(s.execution_count)\r\n      FROM\r\n          sys.dm_exec_query_stats AS s\r\n      GROUP BY\r\n          s.query_hash\r\n         ,s.statement_start_offset\r\n         ,s.statement_end_offset\r\n      HAVING\r\n          COUNT(s.query_hash) > 100\r\n      ORDER BY\r\n          4 DESC /* What the hell Brent? */\r\n  )\r\nSELECT\r\n    r.query_hash\r\n   ,r.PlansCached\r\n   ,r.DistinctPlansCached\r\n   ,q.SampleQueryText\r\n   ,r.Total_Executions\r\n   ,r.Total_CPU_ms\r\n   ,r.Total_Duration_ms\r\n   ,r.Total_Reads\r\n   ,r.Total_Writes\r\n   ,r.FirstPlanCreationTime\r\n   ,r.LastPlanCreationTime\r\n   ,r.LastExecutionTime\r\n   ,r.statement_start_offset\r\n   ,r.statement_end_offset\r\n   ,r.sort_order\r\n   --,q.SampleQueryPlan\r\nFROM\r\n    RedundantQueries AS r\r\nCROSS APPLY (\r\n    SELECT TOP 3\r\n        SampleQueryText = st.text\r\n       ,SampleQueryPlan = qp.query_plan\r\n       ,qs.total_elapsed_time\r\n    FROM\r\n        sys.dm_exec_query_stats                     AS qs\r\n    CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) AS st\r\n    CROSS APPLY sys.dm_exec_query_plan(qs.plan_handle) AS qp\r\n    WHERE\r\n        r.query_hash             = qs.query_hash\r\n    AND r.statement_start_offset = qs.statement_start_offset\r\n    AND r.statement_end_offset   = qs.statement_end_offset\r\n    ORDER BY\r\n        qs.total_elapsed_time DESC\r\n)                    AS q\r\nORDER BY\r\n    r.sort_order DESC\r\n   ,r.query_hash\r\n   ,r.statement_start_offset\r\n   ,r.statement_end_offset\r\n   ,q.total_elapsed_time DESC;\r\n"
}