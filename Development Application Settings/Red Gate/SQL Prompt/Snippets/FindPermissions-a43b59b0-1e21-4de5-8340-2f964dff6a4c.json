{
  "id": "a43b59b0-1e21-4de5-8340-2f964dff6a4c",
  "prefix": "FindPermissions",
  "description": "KM: SQL Server Permissions (Users, Roles, Securables)",
  "body": "/**********************************************************************************************************************\n** PowerShell to find the name of the server you're currently on:\n    hostname\n\n** PowerShell to find information like the groups and privileges you belong to:\n    whoami /all\n\n** PowerShell to check if SQL Server port is open on a server:\n    Test-NetConnection -ComputerName \"[MySQLServerName]\" -Port 1433\n\n** PowerShell to check if an account has permisions to a shared resource:\n    net use \"[\\\\MyComputerName\\MyShareName]\" /user:[MyDomain\\MyUserName] [MyPa$$word* | or * to prompt for password]; net use \"[\\\\MyComputerName\\MyShareName]\" /delete\n**********************************************************************************************************************/\n\n/* General Information */\nSELECT\n    ServerName       = @@SERVERNAME\n   ,DatabaseUserName = USER_NAME()\n   ,LoginName        = SUSER_NAME()\n   ,[Is sysadmin]    = IIF(IS_SRVROLEMEMBER('sysadmin') = 1, 'True', 'False');\nGO\n\n/* My Assigned Roles */\nSELECT\n    RoleName   = R.name\n   ,MemberName = M.name\nFROM\n    sys.database_role_members      AS DRM\nINNER JOIN sys.database_principals AS R ON DRM.role_principal_id   = R.principal_id\nINNER JOIN sys.database_principals AS M ON DRM.member_principal_id = M.principal_id\nWHERE\n    M.name = USER_NAME()\nORDER BY\n    R.name\n   ,M.name;\nGO\n\n/* My Granted Permissions */\nSELECT\n    PermissionName  = DP.permission_name\n   ,PermissionState = DP.state_desc\n   ,ObjectName      = O.name\n   ,ObjectType      = O.type_desc\nFROM\n    sys.database_permissions       AS DP\nLEFT JOIN sys.objects              AS O ON DP.major_id             = O.object_id\nINNER JOIN sys.database_principals AS P ON DP.grantee_principal_id = P.principal_id\nWHERE\n    P.name = USER_NAME()\nORDER BY\n    DP.permission_name\n   ,DP.state_desc;\nGO\n\n/* My Server-Level Roles */\nSELECT\n    LoginName  = SP.name\n   ,ServerRole = SLR.name\nFROM\n    sys.server_role_members AS SRM\nJOIN sys.server_principals  AS SP ON SRM.member_principal_id = SP.principal_id\nJOIN sys.server_principals  AS SLR ON SRM.role_principal_id  = SLR.principal_id\nWHERE\n    SP.name = SUSER_NAME()\nORDER BY\n    SP.name\n   ,SLR.name;\nGO\n\n/* My Schema-Level Permissions */\nSELECT\n    PermissionName  = DP.permission_name\n   ,PermissionState = DP.state_desc\n   ,SchemaName      = S.name\nFROM\n    sys.database_permissions AS DP\nJOIN sys.schemas             AS S ON DP.major_id             = S.schema_id\nJOIN sys.database_principals AS P ON DP.grantee_principal_id = P.principal_id\nWHERE\n    P.name = USER_NAME()\nORDER BY\n    DP.permission_name\n   ,DP.state_desc\n   ,S.name;\nGO\n\n/* All Database Users */\nSELECT\n    Username = name\n   ,type_desc\n   ,create_date\n   ,modify_date\nFROM\n    sys.database_principals\nWHERE\n    type_desc NOT IN ('DATABASE_ROLE')\nAND sid IS NOT NULL\nORDER BY\n    Username;\nGO\n\n/* All Role Members */\nSELECT\n    DatabaseRoleName = R.name\n   ,DatabaseUserName = ISNULL(U.name, 'No members')\nFROM\n    sys.database_principals         AS R\nLEFT JOIN sys.database_role_members AS M ON R.principal_id        = M.role_principal_id\nLEFT JOIN sys.database_principals   AS U ON M.member_principal_id = U.principal_id\nWHERE\n    R.type = 'R'\nORDER BY\n    R.name;\nGO\n\n/* All Logins (SQL and Windows) with Server Roles and Disabled Status */\nSELECT\n    LoginName   = SP.name\n   ,LoginType   = SP.type_desc\n   ,IsDisabled  = SP.is_disabled\n   ,ServerRoles = ISNULL(STUFF((\n                                   SELECT\n                                       ', ' + SR.name\n                                   FROM\n                                       sys.server_role_members AS SRM\n                                   JOIN sys.server_principals  AS SR ON SRM.role_principal_id = SR.principal_id\n                                   WHERE\n                                       SRM.member_principal_id = SP.principal_id\n                                   FOR XML PATH(''), TYPE\n                               ).value('.', 'NVARCHAR(MAX)')\n                            ,1\n                            ,2\n                            ,''\n                         )\n                     ,'No Roles'\n                  )\n   ,SP.create_date\n   ,SP.modify_date\nFROM\n    sys.server_principals         AS SP\nLEFT JOIN sys.server_role_members AS SRM ON SP.principal_id       = SRM.member_principal_id\nLEFT JOIN sys.server_principals   AS SRP ON SRM.role_principal_id = SRP.principal_id\nWHERE\n    SP.type_desc IN ('SQL_LOGIN', 'WINDOWS_LOGIN', 'WINDOWS_GROUP')\nORDER BY\n    LoginName;\nGO\n\n/* All Role Permissions */\nSELECT\n    PrincipalName   = R.name\n   ,PrincipalType   = R.type_desc\n   ,GrantedBy       = ISNULL(G.name, 'System')\n   ,PermissionName  = P.permission_name\n   ,PermissionState = P.state_desc\n   ,ObjectName      = ISNULL(O.name, 'N/A')\n   ,ObjectType      = ISNULL(O.type_desc, 'N/A')\nFROM\n    sys.database_permissions      AS P\nLEFT JOIN sys.objects             AS O ON P.major_id             = O.object_id\nLEFT JOIN sys.database_principals AS R ON P.grantee_principal_id = R.principal_id\nLEFT JOIN sys.database_principals AS G ON P.grantor_principal_id = G.principal_id\nWHERE\n    R.type_desc = 'DATABASE_ROLE'\nAND R.name NOT IN ('public')\nORDER BY\n    R.name\n   ,P.permission_name;\nGO\n\n/* Stored Procedure Permissions */\nSELECT\n    SchemaName          = S.name\n   ,StoredProcedureName = O.name\n   ,PermissionState     = DP.state_desc\n   ,PermissionName      = DP.permission_name\n   ,GranteeName         = P.name\nFROM\n    sys.database_permissions      AS DP\nINNER JOIN sys.objects            AS O ON DP.major_id             = O.object_id\nINNER JOIN sys.schemas            AS S ON O.schema_id             = S.schema_id\nLEFT JOIN sys.database_principals AS P ON DP.grantee_principal_id = P.principal_id\nWHERE\n    O.type = 'P'\nORDER BY\n    SchemaName\n   ,StoredProcedureName\n   ,GranteeName\n   ,PermissionName;\nGO\n\n/* Schema Permissions */\nSELECT\n    SchemaName      = S.name\n   ,PermissionState = DP.state_desc\n   ,PermissionName  = DP.permission_name\n   ,UserName        = U.name\nFROM\n    sys.database_permissions      AS DP\nLEFT JOIN sys.objects             AS O ON DP.major_id             = O.object_id\nLEFT JOIN sys.schemas             AS S ON DP.major_id             = S.schema_id\nLEFT JOIN sys.database_principals AS U ON DP.grantee_principal_id = U.principal_id\nWHERE\n    DP.class_desc = 'SCHEMA'\nORDER BY\n    SchemaName\n   ,PermissionName\n   ,UserName\nGO\n\n/* Table & View Permissions */\nSELECT\n    SchemaName      = S.name\n   ,ObjectName      = O.name\n   ,ObjectType      = O.type_desc\n   ,UserName        = U.name\n   ,PermissionState = DP.state_desc\n   ,PermissionName  = DP.permission_name\nFROM\n    sys.database_permissions      AS DP\nLEFT JOIN sys.objects             AS O ON DP.major_id             = O.object_id\nLEFT JOIN sys.schemas             AS S ON O.schema_id             = S.schema_id\nLEFT JOIN sys.database_principals AS U ON DP.grantee_principal_id = U.principal_id\nWHERE\n    O.type IN ('U', 'V')\nAND DP.class_desc = 'OBJECT_OR_COLUMN'\nAND U.name NOT IN ('public')\nORDER BY\n    SchemaName\n   ,ObjectName\n   ,UserName\n   ,PermissionName\n   ,PermissionState;\nGO"
}