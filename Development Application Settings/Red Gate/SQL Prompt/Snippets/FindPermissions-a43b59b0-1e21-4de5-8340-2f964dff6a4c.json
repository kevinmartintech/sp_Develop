{
  "id": "a43b59b0-1e21-4de5-8340-2f964dff6a4c",
  "prefix": "FindPermissions",
  "description": "KM: SQL Server Permissions (Users, Roles, Securables)",
  "body": "SELECT ServerName = @@SERVERNAME;\n\n/* My Server Roles */\nSELECT\n    ServerRole = r.name\nFROM\n    master.sys.server_role_members      AS rm\nINNER JOIN master.sys.server_principals AS r ON r.principal_id = rm.role_principal_id\nINNER JOIN master.sys.server_principals AS m ON m.principal_id = rm.member_principal_id\nWHERE\n    m.name = SUSER_NAME()\nAND r.type = 'R'\nUNION\nSELECT\n    Role = IIF(IS_SRVROLEMEMBER('sysadmin') = 1, 'Is sysadmin', 'Not sysadmin');\n\n/* My Database Roles */\nSELECT\n    DatabaseRole = r.name\nFROM\n    sys.database_role_members      AS rm\nINNER JOIN sys.database_principals AS r ON rm.role_principal_id   = r.principal_id\nINNER JOIN sys.database_principals AS m ON rm.member_principal_id = m.principal_id\nWHERE\n    m.name = SUSER_NAME();\n\n/* All Database Users */\nSELECT\n    Username            = name\n   ,create_date\n   ,modify_date\n   ,type                = type_desc\n   ,authentication_type = authentication_type_desc\nFROM\n    sys.database_principals\nWHERE\n    type NOT IN ('A', 'G', 'R')\nAND sid IS NOT NULL\nORDER BY\n    Username;\n\n\n/* All Role Members */\nSELECT\n    DatabaseRoleName = DP1.name\n   ,DatabaseUserName = ISNULL(DP2.name, 'No members')\nFROM\n    sys.database_role_members            AS DRM\nRIGHT OUTER JOIN sys.database_principals AS DP1 ON DRM.role_principal_id   = DP1.principal_id\nLEFT OUTER JOIN sys.database_principals  AS DP2 ON DRM.member_principal_id = DP2.principal_id\nWHERE\n    DP1.type = 'R'\nORDER BY\n    DP1.name;\n\n\n/* All Role Securables */\nSELECT\n    Securable = 'GRANT ' + perm.permission_name + ' ON ' + CASE perm.class_desc\n                                                               WHEN 'SCHEMA'\n                                                                   THEN SCHEMA_NAME(perm.major_id)\n                                                               WHEN 'OBJECT_OR_COLUMN'\n                                                                   THEN CASE WHEN perm.minor_id = 0\n                                                                                 THEN OBJECT_NAME(perm.major_id)COLLATE Latin1_General_CI_AS_KS_WS\n                                                                            ELSE (\n                                                                            SELECT\n                                                                                OBJECT_NAME(object_id) + ' (' + name + ')'\n                                                                            FROM\n                                                                                sys.columns\n                                                                            WHERE\n                                                                                object_id = perm.major_id\n                                                                            AND column_id = perm.minor_id\n                                                                        )\n                                                                        END\n                                                               ELSE 'other'\n                                                           END + ' TO ' + prin.name COLLATE Latin1_General_CI_AS_KS_WS\nFROM\n    sys.database_permissions       AS perm\nINNER JOIN sys.database_principals AS prin ON perm.grantee_principal_id = prin.principal_id\nLEFT JOIN sys.objects              AS o ON o.object_id                  = perm.major_id /* consider schemas */\nWHERE\n    perm.major_id > 0\nAND perm.permission_name IN ('SELECT', 'INSERT', 'UPDATE', 'DELETE');\n\n\n/* All Role Permissions  */\nSELECT\n    DBName        = DB_NAME()\n   ,PrincipalName = p.name\n   ,PrincipalType = p.type_desc\n   ,GrantedBy     = p2.name\n   ,dbp.permission_name\n   ,dbp.state_desc\n   ,ObjectName    = so.name\n   ,ObjectType    = so.type_desc\nFROM\n    sys.database_permissions      AS dbp\nLEFT JOIN sys.objects             AS so ON dbp.major_id             = so.object_id\nLEFT JOIN sys.database_principals AS p ON dbp.grantee_principal_id  = p.principal_id\nLEFT JOIN sys.database_principals AS p2 ON dbp.grantor_principal_id = p2.principal_id\nWHERE\n    p.type_desc = 'DATABASE_ROLE'\nAND p.name NOT IN ('public');\n"
}