{
  "id": "f1f92238-aaa4-4ed4-9adb-bf5337e25efd",
  "prefix": "FindWebLoadHistory",
  "description": "KM: Use this to find the webload history information",
  "body": "USE VentureAccess;\r\n\r\n/* What count of files are still waiting to be processed */\r\nDECLARE\r\n    @UnProcessedCount int\r\n   ,@MinCreateDate    datetime2(7)\r\n   ,@MaxCreateDate    datetime2(7);\r\n\r\nSELECT\r\n    @UnProcessedCount = COUNT(*)\r\nFROM\r\n    dbo.WEBLOAD_HISTORY\r\nWHERE\r\n    STATUS = 0\r\nAND FILENAME NOT LIKE 'trailer%'\r\nAND FILENAME NOT LIKE 'flightchk%';\r\n\r\n\r\n/* Max and Min File Created Date */\r\nSELECT\r\n    @MaxCreateDate = MAX(CreateDate)\r\n   ,@MinCreateDate = MIN(CreateDate)\r\nFROM\r\n    dbo.WEBLOAD_HISTORY\r\nWHERE\r\n    Status = 0\r\nAND FileName NOT LIKE 'trailer%'\r\nAND FileName NOT LIKE 'flightchk%';\r\n\r\n\r\n/* How far are we behind */\r\nSELECT TOP (1)\r\n    [Time Behind (hh:mm)] = CONVERT(varchar(5), DATEADD(MINUTE, DATEDIFF(MINUTE, CreateDate, SYSDATETIME()), 0), 114)\r\n   ,UnProcessedCount      = @UnProcessedCount\r\n   ,MaxCreateDate         = @MaxCreateDate\r\n   ,MinCreateDate         = @MinCreateDate\r\nFROM\r\n    dbo.WEBLOAD_HISTORY\r\nWHERE\r\n    Status = 0\r\nAND FileName NOT LIKE 'trailer%'\r\nAND FileName NOT LIKE 'flightchk%'\r\nORDER BY\r\n    CreateDate ASC;\r\n\r\n\r\n/* Last 3000 Processed Files */\r\nWITH TimeDiffs\r\n  AS (\r\n      SELECT TOP (3000)\r\n          ID\r\n         ,Type\r\n         ,FolderName\r\n         ,CreateDate\r\n         ,FileName\r\n         ,ProcessedOn\r\n         ,Status\r\n         ,NumOfFailures\r\n         ,PrevProcessedOn = LAG(ProcessedOn) OVER (ORDER BY ProcessedOn ASC)\r\n      FROM\r\n          dbo.WEBLOAD_HISTORY\r\n      WHERE\r\n          FileName NOT LIKE 'trailer%'\r\n      AND FileName NOT LIKE 'flightchk%'\r\n      AND ProcessedOn IS NOT NULL\r\n      ORDER BY\r\n          ProcessedOn DESC\r\n  )\r\nSELECT\r\n    ID\r\n   ,Type\r\n   ,FolderName\r\n   ,CreateDate\r\n   ,FileName\r\n   ,ProcessedOn\r\n   ,[Duration (hh:mm:ss:ms)] = CASE WHEN PrevProcessedOn IS NULL\r\n                                        THEN NULL\r\n                                   ELSE\r\n                                       RIGHT('00' + CAST(DATEDIFF_BIG(MILLISECOND, PrevProcessedOn, ProcessedOn) / 3600000 AS varchar), 2) + ':'\r\n                                       + RIGHT('00' + CAST((DATEDIFF_BIG(MILLISECOND, PrevProcessedOn, ProcessedOn) % 3600000) / 60000 AS varchar), 2) + ':'\r\n                                       + RIGHT('00' + CAST((DATEDIFF_BIG(MILLISECOND, PrevProcessedOn, ProcessedOn) % 60000) / 1000 AS varchar), 2) + '.'\r\n                                       + RIGHT('000' + CAST(DATEDIFF_BIG(MILLISECOND, PrevProcessedOn, ProcessedOn) % 1000 AS varchar), 3)\r\n                               END\r\n   ,Status\r\n   ,NumOfFailures\r\nFROM\r\n    TimeDiffs\r\nORDER BY\r\n    ProcessedOn DESC;\r\n\r\n\r\nRETURN;\r\n\r\n/* What files are still waiting to be processed */\r\nSELECT\r\n    ID\r\n   ,Type\r\n   ,FolderName\r\n   ,CreateDate\r\n   ,FileName\r\n   ,ProcessedOn\r\n   ,Status\r\n   ,NumOfFailures\r\nFROM\r\n    dbo.WEBLOAD_HISTORY\r\nWHERE\r\n    Status = 0\r\nAND FileName NOT LIKE 'trailer%'\r\nAND FileName NOT LIKE 'flightchk%'\r\nORDER BY\r\n    ID ASC;\r\n\r\n/* \r\n    What is the history of the web load\r\n    This result can be used in Excel to pivot or graph the data count per hour/day and by customer(CUSTNUM)\r\n*/\r\nSELECT\r\n    RowTotal    = COUNT(*)\r\n   ,YearPart    = ca.YearPart\r\n   ,MonthPart   = ca.MonthPart\r\n   ,DayPart     = ca.DayPart\r\n   ,HourPart    = ca.HourPart\r\n   ,AmPmPart    = ca.AmPmPart\r\n   ,WeekdayPart = ca.WeekdayPart\r\n   ,CUSTNUM     = ca.CUSTNUM\r\nFROM\r\n    dbo.WEBLOAD_HISTORY AS h\r\nCROSS APPLY (\r\n    SELECT\r\n        YearPart    = DATEPART(YEAR, CreateDate)\r\n       ,MonthPart   = DATEPART(MONTH, CreateDate)\r\n       ,DayPart     = DATEPART(DAY, CreateDate)\r\n       ,HourPart    = DATEPART(HOUR, CreateDate)\r\n       ,AmPmPart    = CONVERT(varchar(15), CAST(TIMEFROMPARTS(DATEPART(HOUR, CreateDate), 0, 0, 0, 0) AS time), 100)\r\n       ,WeekdayPart = DATENAME(WEEKDAY, CreateDate)\r\n       ,CUSTNUM     = CASE WHEN CHARINDEX('-', h.FileName) > 0\r\n                               THEN LEFT(h.FileName, CHARINDEX('-', h.FileName) - 1)\r\n                          WHEN CHARINDEX('_', h.FileName) > 0\r\n                              THEN LEFT(h.FileName, CHARINDEX('_', h.FileName) - 1)\r\n                          WHEN h.FileName LIKE 'CERT.TXT%'\r\n                              THEN 'CERT'\r\n                          WHEN h.FileName LIKE 'FLIGHTCHK%'\r\n                              THEN 'FLIGHTCHK'\r\n                          WHEN h.FileName LIKE 'TRAILER.%'\r\n                              THEN 'TRAILER'\r\n                          WHEN CHARINDEX('.', h.FileName) > 0\r\n                              THEN LEFT(h.FileName, CHARINDEX('.', h.FileName) - 1)\r\n                          ELSE h.FileName\r\n                      END\r\n)                       AS ca\r\n--WHERE\r\n--    h.FileName NOT IN ('ACCTDEF.TXT','GRP.TXT', 'CMSGGRP.TXT', 'CUSTOMER.TXT', 'DOCIDS.TXT', 'DVCPROD.TXT', 'JCMPUSE.TXT', 'JOB.TXT', 'LMSGRPS.TXT', 'MSGDEF.TXT','PRDGRP2.TXT', 'PRODGRP.TXT', 'PRODTYPE.TXT', 'PRODUCT.TXT', 'TIPDEF.TXT', 'TIPGRPS.TXT', 'TIPPRDS.TXT', 'USRGRP2.TXT')\r\n--    AND h.FileName NOT LIKE 'CERT.TXT.%'\r\n--    AND h.FileName NOT LIKE 'FLIGHTCHK%'\r\n--    AND h.FileName NOT LIKE 'TRAILER.%'\r\nGROUP BY\r\n    ca.YearPart\r\n   ,ca.MonthPart\r\n   ,ca.DayPart\r\n   ,ca.HourPart\r\n   ,ca.AmPmPart\r\n   ,ca.WeekdayPart\r\n   ,ca.CUSTNUM\r\nORDER BY\r\n    ca.YearPart\r\n   ,ca.MonthPart\r\n   ,ca.DayPart\r\n   ,ca.HourPart\r\n   ,ca.AmPmPart\r\n   ,ca.WeekdayPart\r\n   ,ca.CUSTNUM;"
}