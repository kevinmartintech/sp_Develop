{
  "id": "f1f92238-aaa4-4ed4-9adb-bf5337e25efd",
  "prefix": "FindWebLoadHistory",
  "description": "KM: Use this to find the webload history information",
  "body": "USE VentureAccess;\r\n\r\nSET NOCOUNT ON;\r\nSET LOCK_TIMEOUT 1000;\r\n\r\n/* What count of files are still waiting to be processed */\r\nDECLARE\r\n    @UnProcessedCount bigint\r\n   ,@MinCreateDate    datetime2(7)\r\n   ,@MaxCreateDate    datetime2(7);\r\n\r\nDROP TABLE IF EXISTS #PendingWebloadHistory;\r\nSELECT\r\n    H.ID\r\n   ,H.Type\r\n   ,H.CreateDate\r\n   ,H.NumOfFailures\r\n   ,H.FolderName\r\n   ,H.FileName\r\n   ,CUSTNUM = LEFT(H.FileName, 6)\r\n   ,PRODNUM = SUBSTRING(H.FileName, 8, 6)\r\n   ,JOBNUM  = SUBSTRING(H.FileName, 15, 6)\r\nINTO\r\n    #PendingWebloadHistory\r\nFROM\r\n    dbo.WEBLOAD_HISTORY AS H\r\nWHERE\r\n    H.Status = 0\r\nAND H.FileName NOT LIKE 'trailer%'\r\nAND H.FileName NOT LIKE 'flightchk%';\r\n\r\nSELECT\r\n    @UnProcessedCount = COUNT_BIG(*)\r\n   ,@MaxCreateDate    = MAX(H.CreateDate)\r\n   ,@MinCreateDate    = MIN(H.CreateDate)\r\nFROM\r\n    #PendingWebloadHistory AS H;\r\n\r\n\r\n/* How far are we behind */\r\nSELECT\r\n    [Time Behind (hh:mm)] = CASE WHEN @MinCreateDate IS NULL\r\n                                     THEN NULL\r\n                                ELSE CAST(T.TotalHours AS varchar(20)) + ':' + RIGHT('00' + CAST(T.Minutes AS varchar(2)), 2)\r\n                            END\r\n   ,UnProcessedCount      = @UnProcessedCount\r\n   ,MaxCreateDate         = @MaxCreateDate\r\n   ,MinCreateDate         = @MinCreateDate\r\nFROM (SELECT DurationMs = DATEDIFF_BIG(MILLISECOND, @MinCreateDate, SYSDATETIME()))                  AS D\r\nCROSS APPLY (SELECT TotalHours = D.DurationMs / 3600000, Minutes = (D.DurationMs % 3600000) / 60000) AS T;\r\n\r\n\r\n\r\n\r\n;WITH PendingKeys\r\n   AS (SELECT DISTINCT H.CUSTNUM, H.PRODNUM, H.JOBNUM FROM #PendingWebloadHistory AS H)\r\n,AcctCounts\r\n   AS (\r\n       SELECT\r\n           A.CUSTNUM\r\n          ,A.PRODNUM\r\n          ,A.JOBNUM\r\n          ,CurrentCount = COUNT_BIG(*)\r\n       FROM\r\n           dbo.CO_ACCTDTL     AS A\r\n       INNER JOIN PendingKeys AS K ON K.CUSTNUM  = A.CUSTNUM\r\n                                   AND K.PRODNUM = A.PRODNUM\r\n                                   AND K.JOBNUM  = A.JOBNUM\r\n       GROUP BY\r\n           A.CUSTNUM\r\n          ,A.PRODNUM\r\n          ,A.JOBNUM\r\n   )\r\n/* What files are still waiting to be processed (with current acctdtl count) */\r\nSELECT\r\n    H.ID\r\n   ,H.Type\r\n   ,H.CreateDate\r\n   ,J.PRODCNT\r\n   ,CurrentCount    = COALESCE(CA.CurrentCount, 0)\r\n   /* ,H.ProcessedOn */\r\n   ,C.CUSTNAME\r\n   ,ExtraProcessing = CASE WHEN H.CUSTNUM IN ('02000Z', '87400Z', '81400Z', '89900Z', '02400Z', '89700Z')\r\n                               THEN 'Yes'\r\n                          ELSE 'No'\r\n                      END\r\n   ,FlightCheck     = CASE WHEN P.FLITE_CHK_APPR_REQ = 'Y' THEN 'Yes' ELSE 'No' END\r\n   ,H.NumOfFailures\r\n   ,H.FolderName\r\n   ,H.FileName\r\n/* ,H.Status */\r\nFROM\r\n    #PendingWebloadHistory      AS H\r\nLEFT OUTER JOIN dbo.CO_CUSTOMER AS C ON C.CUSTNUM    = H.CUSTNUM\r\nLEFT OUTER JOIN dbo.CO_PRODUCTS AS P ON P.CUSTNUM    = H.CUSTNUM\r\n                                     AND P.PRODNUM   = H.PRODNUM\r\nLEFT OUTER JOIN dbo.VA_JOB      AS J ON J.CUSTNUM    = H.CUSTNUM\r\n                                     AND J.PRODNUM   = H.PRODNUM\r\n                                     AND J.JOBNUM    = H.JOBNUM\r\nLEFT OUTER JOIN AcctCounts      AS CA ON CA.CUSTNUM  = H.CUSTNUM\r\n                                      AND CA.PRODNUM = H.PRODNUM\r\n                                      AND CA.JOBNUM  = H.JOBNUM\r\nORDER BY\r\n    H.ID ASC;\r\n\r\n\r\n\r\n\r\n/* Last 3000 Processed Files */\r\nWITH TimeDiffs\r\n  AS (\r\n      SELECT TOP (3001)\r\n          H.ID\r\n         ,H.Type\r\n         ,H.FolderName\r\n         ,H.CreateDate\r\n         ,H.FileName\r\n         ,H.ProcessedOn\r\n         ,H.Status\r\n         ,H.NumOfFailures\r\n         ,CUSTNUM = LEFT(H.FileName, 6)\r\n         ,PRODNUM = SUBSTRING(H.FileName, 8, 6)\r\n         ,JOBNUM  = SUBSTRING(H.FileName, 15, 6)\r\n      FROM\r\n          dbo.WEBLOAD_HISTORY AS H\r\n      WHERE\r\n          H.FileName NOT LIKE 'trailer%'\r\n      AND H.FileName NOT LIKE 'flightchk%'\r\n      AND H.ProcessedOn IS NOT NULL\r\n      ORDER BY\r\n          H.ProcessedOn DESC\r\n         ,H.ID ASC\r\n  )\r\nSELECT TOP (3000)\r\n    D.ID\r\n   ,D.Type\r\n   ,D.CreateDate\r\n   ,D.ProcessedOn\r\n   ,C.CUSTNAME\r\n   ,J.PRODCNT\r\n   ,[Duration (hh:mm:ss:ms)] = CASE WHEN D.PrevProcessedOn IS NULL\r\n                                        THEN NULL\r\n                                   ELSE\r\n                                       RIGHT('00' + CAST(T.DurationMs / 3600000 AS varchar), 2) + ':'\r\n                                       + RIGHT('00' + CAST((T.DurationMs % 3600000) / 60000 AS varchar), 2) + ':'\r\n                                       + RIGHT('00' + CAST((T.DurationMs % 60000) / 1000 AS varchar), 2) + '.'\r\n                                       + RIGHT('000' + CAST(T.DurationMs % 1000 AS varchar), 3)\r\n                               END\r\n   ,ExtraProcessing = CASE WHEN D.CUSTNUM IN ('02000Z', '87400Z', '81400Z', '89900Z', '02400Z', '89700Z')\r\n                               THEN 'Yes'\r\n                          ELSE 'No'\r\n                      END\r\n   ,FlightCheck     = CASE WHEN P.FLITE_CHK_APPR_REQ = 'Y' THEN 'Yes' ELSE 'No' END\r\n   ,D.NumOfFailures\r\n   ,D.FolderName\r\n   ,D.FileName\r\n   ,D.Status\r\nFROM (\r\n    SELECT\r\n        ID\r\n       ,Type\r\n       ,FolderName\r\n       ,CreateDate\r\n       ,FileName\r\n       ,ProcessedOn\r\n       ,Status\r\n       ,NumOfFailures\r\n       ,CUSTNUM\r\n       ,PRODNUM\r\n       ,JOBNUM\r\n       ,PrevProcessedOn = LAG(ProcessedOn) OVER (ORDER BY ProcessedOn ASC, ID ASC)\r\n    FROM\r\n        TimeDiffs\r\n)                                                                                             AS D\r\nLEFT OUTER JOIN dbo.CO_CUSTOMER                                                                AS C ON C.CUSTNUM = D.CUSTNUM\r\nLEFT OUTER JOIN dbo.CO_PRODUCTS                                                                AS P ON P.CUSTNUM = D.CUSTNUM\r\n                                                                                                    AND P.PRODNUM = D.PRODNUM\r\nLEFT OUTER JOIN dbo.VA_JOB                                                                     AS J ON J.CUSTNUM = D.CUSTNUM\r\n                                                                                                    AND J.PRODNUM = D.PRODNUM\r\n                                                                                                    AND J.JOBNUM  = D.JOBNUM\r\nOUTER APPLY (SELECT DurationMs = DATEDIFF_BIG(MILLISECOND, D.PrevProcessedOn, D.ProcessedOn)) AS T\r\nORDER BY\r\n    D.ProcessedOn DESC;\r\n\r\n\r\n\r\n\r\n\r\n\r\nRETURN;\r\n\r\n/* \r\n    What is the history of the web load\r\n    This result can be used in Excel to pivot or graph the data count per hour/day and by customer(CUSTNUM)\r\n*/\r\nSELECT\r\n    RowTotal    = COUNT(*)\r\n   ,YearPart    = ca.YearPart\r\n   ,MonthPart   = ca.MonthPart\r\n   ,DayPart     = ca.DayPart\r\n   ,HourPart    = ca.HourPart\r\n   ,AmPmPart    = ca.AmPmPart\r\n   ,WeekdayPart = ca.WeekdayPart\r\n   ,CUSTNUM     = ca.CUSTNUM\r\nFROM\r\n    dbo.WEBLOAD_HISTORY AS h\r\nCROSS APPLY (\r\n    SELECT\r\n        YearPart    = DATEPART(YEAR, CreateDate)\r\n       ,MonthPart   = DATEPART(MONTH, CreateDate)\r\n       ,DayPart     = DATEPART(DAY, CreateDate)\r\n       ,HourPart    = DATEPART(HOUR, CreateDate)\r\n       ,AmPmPart    = CONVERT(varchar(15), CAST(TIMEFROMPARTS(DATEPART(HOUR, CreateDate), 0, 0, 0, 0) AS time), 100)\r\n       ,WeekdayPart = DATENAME(WEEKDAY, CreateDate)\r\n       ,CUSTNUM     = CASE WHEN CHARINDEX('-', h.FileName) > 0\r\n                               THEN LEFT(h.FileName, CHARINDEX('-', h.FileName) - 1)\r\n                          WHEN CHARINDEX('_', h.FileName) > 0\r\n                              THEN LEFT(h.FileName, CHARINDEX('_', h.FileName) - 1)\r\n                          WHEN h.FileName LIKE 'CERT.TXT%'\r\n                              THEN 'CERT'\r\n                          WHEN h.FileName LIKE 'FLIGHTCHK%'\r\n                              THEN 'FLIGHTCHK'\r\n                          WHEN h.FileName LIKE 'TRAILER.%'\r\n                              THEN 'TRAILER'\r\n                          WHEN CHARINDEX('.', h.FileName) > 0\r\n                              THEN LEFT(h.FileName, CHARINDEX('.', h.FileName) - 1)\r\n                          ELSE h.FileName\r\n                      END\r\n)                       AS ca\r\n--WHERE\r\n--    h.FileName NOT IN ('ACCTDEF.TXT','GRP.TXT', 'CMSGGRP.TXT', 'CUSTOMER.TXT', 'DOCIDS.TXT', 'DVCPROD.TXT', 'JCMPUSE.TXT', 'JOB.TXT', 'LMSGRPS.TXT', 'MSGDEF.TXT','PRDGRP2.TXT', 'PRODGRP.TXT', 'PRODTYPE.TXT', 'PRODUCT.TXT', 'TIPDEF.TXT', 'TIPGRPS.TXT', 'TIPPRDS.TXT', 'USRGRP2.TXT')\r\n--    AND h.FileName NOT LIKE 'CERT.TXT.%'\r\n--    AND h.FileName NOT LIKE 'flightchk%'\r\n--    AND h.FileName NOT LIKE 'TRAILER.%'\r\nGROUP BY\r\n    ca.YearPart\r\n   ,ca.MonthPart\r\n   ,ca.DayPart\r\n   ,ca.HourPart\r\n   ,ca.AmPmPart\r\n   ,ca.WeekdayPart\r\n   ,ca.CUSTNUM\r\nORDER BY\r\n    ca.YearPart\r\n   ,ca.MonthPart\r\n   ,ca.DayPart\r\n   ,ca.HourPart\r\n   ,ca.AmPmPart\r\n   ,ca.WeekdayPart\r\n   ,ca.CUSTNUM;\r\nGO\r\n"
}