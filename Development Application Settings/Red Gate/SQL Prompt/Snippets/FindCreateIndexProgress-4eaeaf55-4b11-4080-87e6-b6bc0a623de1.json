{
  "id": "4eaeaf55-4b11-4080-87e6-b6bc0a623de1",
  "prefix": "FindCreateIndexProgress",
  "description": "KM: Find create index progress",
  "body": ";WITH agg\r\n   AS (\r\n       SELECT\r\n           qp.session_id\r\n          ,RowsProcessed = SUM(qp.row_count)\r\n          ,TotalRows     = SUM(qp.estimate_row_count)\r\n          ,ElapsedMS     = MAX(qp.last_active_time) - MIN(qp.first_active_time)\r\n          ,CurrentStep   = MAX(IIF(qp.close_time = 0 AND qp.first_row_time > 0, qp.physical_operator_name, N'<Transition>'))\r\n       FROM\r\n           sys.dm_exec_query_profiles AS qp\r\n       WHERE\r\n           qp.physical_operator_name IN (N'Table Scan', N'Clustered Index Scan', N'Index Scan', N'Sort')\r\n       AND qp.session_id IN (\r\n               SELECT\r\n                   session_id\r\n               FROM\r\n                   sys.dm_exec_requests\r\n               WHERE\r\n                   command IN ('CREATE INDEX', 'ALTER INDEX', 'ALTER TABLE')\r\n           )\r\n       GROUP BY\r\n           qp.session_id\r\n   )\r\n,comp\r\n   AS (\r\n       SELECT\r\n           *\r\n          ,RowsLeft       = (agg.TotalRows - agg.RowsProcessed)\r\n          ,ElapsedSeconds = (agg.ElapsedMS / 1000.0)\r\n       FROM\r\n           agg\r\n   )\r\nSELECT\r\n    comp.session_id\r\n   ,comp.CurrentStep\r\n   ,comp.TotalRows\r\n   ,comp.RowsProcessed\r\n   ,comp.RowsLeft\r\n   ,PercentComplete         = CONVERT(decimal(5, 2), ((comp.RowsProcessed * 1.0) / comp.TotalRows) * 100)\r\n   ,comp.ElapsedSeconds\r\n   ,EstimatedSecondsLeft    = ((comp.ElapsedSeconds / comp.RowsProcessed) * comp.RowsLeft)\r\n   ,EstimatedCompletionTime = DATEADD(SECOND, ((comp.ElapsedSeconds / comp.RowsProcessed) * comp.RowsLeft), GETDATE())\r\nFROM\r\n    comp;"
}