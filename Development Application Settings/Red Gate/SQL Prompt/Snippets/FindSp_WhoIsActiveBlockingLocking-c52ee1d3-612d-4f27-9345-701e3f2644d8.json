{
  "id": "c52ee1d3-612d-4f27-9345-701e3f2644d8",
  "prefix": "FindSp_WhoIsActiveBlockingLocking",
  "description": "KM: sp_WhoIsActive with blocking and locking check",
  "body": "--DECLARE @schema varchar(MAX);\r\nEXEC master.dbo.sp_WhoIsActive @get_locks = 1, @find_block_leaders = 1, @get_plans = 1, @output_column_list = '\r\n[dd hh:mm:ss.mss][sql_text][query_plan][locks][blocking_session_id][blocked_session_count][wait_info]\r\n\r\n[CPU][used_memory][reads][writes][physical_reads]\r\n\r\n[status][open_tran_count][percent_complete]\r\n\r\n[host_name]\r\n[database_name]\r\n[program_name]\r\n[session_id][login_name]\r\n\r\n[start_time]\r\n[login_time]\r\n[collection_time]';\r\n\r\n/* Monitor Locking */\r\nSELECT\r\n    resource_type\r\n   ,database_name       = DB_NAME(resource_database_id)\r\n   ,entity_name         = OBJECT_NAME(resource_associated_entity_id, resource_database_id)\r\n   ,resource_description\r\n   ,request_type\r\n   ,request_mode\r\n   ,request_status\r\n   ,request_owner_type\r\nFROM\r\n    sys.dm_tran_locks\r\nWHERE\r\n\trequest_mode IN( N'X', N'IX', N'IS')\r\n    /* request_session_id = YourSessionID */\r\n/* AND resource_database_id          = DB_ID('DatabaseName') */\r\nAND resource_associated_entity_id = OBJECT_ID('schema.TableName');\r\n\r\n/* Monitor Blocking */\r\nSELECT\r\n\tblocking_session_id\r\n   ,session_id\r\n   ,command\r\n   ,wait_type\r\n   ,last_wait_type\r\n   ,wait_time\r\n   ,wait_resource\r\nFROM\r\n    sys.dm_exec_requests\r\nWHERE\r\n    blocking_session_id <> 0;"
}