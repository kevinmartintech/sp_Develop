{
  "id": "c52ee1d3-612d-4f27-9345-701e3f2644d8",
  "prefix": "FindSp_WhoIsActiveBlockingLocking",
  "description": "KM: sp_WhoIsActive with blocking and locking check",
  "body": "--DECLARE @schema varchar(MAX);\r\nEXEC dbo.sp_WhoIsActive @find_block_leaders = 1, @get_locks = 1, @get_plans = 1\r\n   -- @filter = NULL               -- sysname\r\n   --,@filter_type = ''            -- varchar(10)\r\n   --,@not_filter = NULL           -- sysname\r\n   --,@not_filter_type = ''        -- varchar(10)\r\n   --,@show_own_spid = NULL        -- bit\r\n   --,@show_system_spids = NULL    -- bit\r\n   --,@show_sleeping_spids = 0     -- tinyint\r\n   --,@get_full_inner_text = NULL  -- bit\r\n   --,@get_plans = 0               -- tinyint\r\n   --,@get_outer_command = NULL    -- bit\r\n   --,@get_transaction_info = NULL -- bit\r\n   --,@get_task_info = 0           -- tinyint\r\n   --,@get_locks = NULL            -- bit\r\n   --,@get_avg_time = NULL         -- bit\r\n   --,@get_additional_info = NULL  -- bit\r\n   --,@find_block_leaders = NULL   -- bit\r\n   --,@delta_interval = 0          -- tinyint\r\n   --,@output_column_list = ''     -- varchar(8000)\r\n   --,@sort_order = ''             -- varchar(500)\r\n   --,@format_output = 0           -- tinyint\r\n   --,@destination_table = ''      -- varchar(4000)\r\n   --,@return_schema = NULL        -- bit\r\n   --,@schema = @schema OUTPUT     -- varchar(max)\r\n   --,@help = NULL                 -- bit\r\n\r\n/* Monitor Locking */\r\nSELECT\r\n    resource_type\r\n   ,database_name       = DB_NAME(resource_database_id)\r\n   ,entity_name         = OBJECT_NAME(resource_associated_entity_id, resource_database_id)\r\n   ,resource_description\r\n   ,request_type\r\n   ,request_mode\r\n   ,request_status\r\n   ,request_owner_type\r\nFROM\r\n    sys.dm_tran_locks\r\nWHERE\r\n    /* request_mode IN( N'X', N'IX', N'IS') */\r\n    resource_database_id          = DB_ID('CentraAccessDirectMessageTracking')\r\nAND resource_associated_entity_id = OBJECT_ID('dbo.DIRECTMESSAGING_EVENTS');\r\n\r\n/* Monitor Blocking */\r\nSELECT\r\n\tblocking_session_id\r\n   ,session_id\r\n   ,command\r\n   ,wait_type\r\n   ,last_wait_type\r\n   ,wait_time\r\n   ,wait_resource\r\nFROM\r\n    sys.dm_exec_requests\r\nWHERE\r\n    blocking_session_id <> 0;"
}